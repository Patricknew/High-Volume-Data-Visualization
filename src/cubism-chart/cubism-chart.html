<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../influxdb-query/influxdb-query.html">
<script src="../../bower_components/d3/d3.min.js"></script>
<script src="../../bower_components/cubism/cubism.v1.js"></script>
<dom-module id="cubism-chart">
<template>
	<style type="text/css">
		
	</style>

  <div id="example1">

    <influxdb-query 
      id = "query2"
      connection="[[connection]]"
      ></influxdb-query>
     
    <paper-button id="showCubism" raised>Show Cubism</paper-button>
    <script type="text/javascript">
      var context = cubism.context()
          .serverDelay(0)
          .clientDelay(0)
          .step(1e3)
          .size(960),
          horizon = context.horizon();
    </script>
  </div>

</template>
<script>

    d3function = function(el, dataResponse, well, measurement) {
      d3.select(el)
        .selectAll(".horizon")
        .call(horizon.remove)
        .remove();

      // var context = cubism.context()
      //     .serverDelay(0)
      //     .clientDelay(0)
      //     .step(1e3)
      //     .size(960);

      var test = formatData();
      function formatData(){
        return context.metric(function(start, stop, step, callback){
        //start time (a Date), stop time (another Date), step interval ( a number in milliseconds), callback
          start = +start;
          stop = +stop;
          var values = [];
          while (start < stop) {
            start += step;
            for (i=0; i<dataResponse.results[0].series[0].values.length; i++) {
            values.push(dataResponse.results[0].series[0].values[i][1]);
          }
          }
          callback(null,values);
        }, name);
      };

      d3.select(el).call(function(div){
        div.append("div")
          .attr("class", "axis")
          .call(context.axis()
            .orient("top"));
        div.selectAll(".horizon")
          .data([test])
          .enter().append("div")
          .attr("class","comparison")
          .call(context.horizon()
          .height(60).title(well + ' ' + measurement + ': '));
        div.append("div")
          .attr("class", "rule")
          .call(context.rule());
      });

    };

    Polymer({

      is: 'cubism-chart',

      listeners:{
        'showCubism.click': 'cubismClick',
      },

      properties: {
        connection: Object,

      	data: {
          type: Object,
        },
        wells: {
          type: Array,
        },
        measurements:{
          type: Array,
        },
        response: { // response object
          type: Object,
          notify: true,
          reflectToAttribute: true,
          readonly: true,
        } , 
        queryResult: {
            type: Object,
        }
      },
    
      cubismClick: function(){
        this.handleQuery();
        d3.select(this.$.example1)
          .selectAll(".comparison")
          .remove();
        d3.select(this.$.example1)
          .selectAll(".axis")
          .remove();
        // console.log(this.$.example1);
      },
      
      handleQuery: function(){
        for (i=0; i<this.wells.length; i++){
          // console.log(well.length);
          for (j=0; j<this.measurements.length; j++){
            this.$.query2.query='select value from "' + this.wells[i] + '.' + this.measurements[j] + '" where time > now() - 1h order by time desc'
            // console.log("1");
            // this.$.query2.query = 'select value from "W631-ESP-PO.Average_Amps" where time > now() - 1h order by time desc'
            var well = this.wells[i];
            var measurement = this.measurements[j];
            this.handleResponse(well, measurement);

        //     this.$.query2.handleQuery().completes.then(function(data){
        //       this.queryResult = data.response;

        //       console.log(well);
        //       d3function(test, data.response, well, measurement);
        //   // this.handleResponse(data);
        //   // d3function(this.$$.example1);

        //   // for (i=0; i<this.queryResult.results[0].series[0].values.length; i++){
        //   //   console.log(this.queryResult.results[0].series[0].values[i]);
        //   // }
        // })
      }}},

      handleResponse: function(well, measurement) {
            var test = this.$.example1;
            // console.log("2");
            this.$.query2.handleQuery().completes.then(function(data){
              this.queryResult = data.response;

              d3function(test, data.response, well, measurement);
          // this.handleResponse(data);
          // d3function(this.$$.example1);

          // for (i=0; i<this.queryResult.results[0].series[0].values.length; i++){
          //   console.log(this.queryResult.results[0].series[0].values[i]);
          // }
        })
      }
    });
    
  </script>
</dom-module>