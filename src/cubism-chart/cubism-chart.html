<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../influxdb-query/influxdb-query.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<script src="../../bower_components/d3/d3.min.js"></script>
<script src="../../bower_components/cubism/cubism.v1.js"></script>
<dom-module id="cubism-chart">
<template>
	<style type="text/css">
		
	</style>

  <div id="example1">

    <influxdb-query 
      id = "query2"
      
      connection="[[connection]]"
      ></influxdb-query>
     
    <paper-button id="showCubism" raised>Show Cubism</paper-button>

  </div>

</template>
<script>
    d3function = function(el) {
      //Generate Random Data
      function random(name) {
        var value = 0,
            values = [],
            i = 0,
            last;
        return context.metric(function(start, stop, step, callback) {
          start = +start, stop = +stop;
          if (isNaN(last)) last = start;
          while (last < stop) {
            last += step;
            value = Math.max(-10, Math.min(10, value + .8 * Math.random() - .4 + .2 * Math.cos(i += .2)));
            values.push(value);
          }
          callback(null, values = values.slice((start - stop) / step));
        }, name);
      }

      var context = cubism.context()
          .serverDelay(0)
          .clientDelay(0)
          .step(1e3)
          .size(960);


      // Random Data
      var foo = random("foo"),
      bar = random("bar");

      d3.select(el).call(function(div) {

        div.append("div")
            .attr("class", "axis")
            .call(context.axis().orient("top"));

        div.selectAll(".horizon")
            .data([foo, bar, foo.add(bar), foo.subtract(bar)])
          .enter().append("div")
            .attr("class", "horizon")
            .call(context.horizon().extent([-20, 20]));

        div.append("div")
            .attr("class", "rule")
            .call(context.rule());

      });
    },

    Polymer({

      is: 'cubism-chart',

      listeners:{
        'showCubism.click': 'handleQuery',
      },

      properties: {
        connection: Object,
      	data: {
          type: Object,
        },
        wells: {
          type: Array,
        },
        measurements:{
          type: Array,
        },
          response: { // response object
            type: Object,
            notify: true,
            readonly: true,
      } , 
        queryResult: {
            type: Object,
        }
      },

      ready: function(){
        d3function(this.$.example1);
      },
      fetchData: function(){
        var queryRequest = this.$.fetch.generateRequest();

        Promise.all([queryRequest.completes])
        .then(function(requests){
          var queryResult = requests[0].response;

          console.log("queryResult");
        })
      },
    
      
      handleQuery: function(){
        this.$.query2.query = 'select value from "W631-ESP-PO.Average_Amps" where time > now() - 1h order by time desc'
        this.$.query2.handleQuery().completes.then(function(data){
          console.log(data.response)
        })
        

      }
    });
        
  </script>
</dom-module>